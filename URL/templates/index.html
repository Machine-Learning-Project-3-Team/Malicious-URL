<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê°ì¸ ë°”ì´ë„ˆê°€ìš´ API URL ê²€ì‚¬</title>
  <link rel="stylesheet" href="/static/css/index.css">
</head>
<body>
  <div class="container">
    <h1>ì•…ì„± URL ê²€ì‚¬</h1>
    <div class="welcome">{{ username }}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤! <a href="/logout" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</a></div>

    <!-- âœ… API í‚¤ ë°œê¸‰ ë²„íŠ¼ -->
    <div class="api-button" onclick="openModal()">
      API í‚¤ ë°œê¸‰
    </div>

    <!-- âœ… ê²€ì‚¬ ê¸°ëŠ¥ -->
    <div class="section">
      <div class="row">
        <div class="label">API + URL</div>
        <input type="text" placeholder="API Key + URL ì…ë ¥">
        <button class="search-button">ê²€ì‚¬</button>
      </div>
      <hr>
      <div class="row">
        <div class="label">URL</div>
        <input type="text" placeholder="URL ì…ë ¥">
        <button class="search-button">ê²€ì‚¬</button>
      </div>
    </div>
  </div>

  <!-- âœ… API Key ë°œê¸‰ ëª¨ë‹¬ -->
  <div id="apiModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>

      <div class="modal-row">
        <div class="modal-label">API Key</div>
        <input type="text" class="modal-input" readonly>
        <button class="copy-btn" onclick="copyAPIKey()">ë³µì‚¬</button>
        <button class="reissue-btn" onclick="reissueAPIKey()">ğŸ” ì¬ë°œê¸‰</button>
      </div>

      <div class="modal-row">
        <div class="modal-label">ìœ íš¨ê¸°ê°„</div>
        <div class="expiration">0000.00.00 00:00</div>
      </div>
    </div>
  </div>

  <!-- âœ… JS ì½”ë“œ -->
  <script>
    // API í‚¤ ë°œê¸‰ ë° ëª¨ë‹¬ í‘œì‹œ
    async function openModal() {
      try {
        const response = await fetch('/issue_api_key');
        const result = await response.json();

        if (response.ok && result.api_key) {
          document.querySelector('.modal-input').value = result.api_key;
          document.querySelector('.expiration').innerText = result.api_expiration;
          document.getElementById('apiModal').style.display = 'block';
        } else {
          alert(result.message || 'API Key ë°œê¸‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('API ìš”ì²­ ì‹¤íŒ¨:', err);
        alert('ì„œë²„ì™€ì˜ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeModal() {
      document.getElementById('apiModal').style.display = 'none';
    }

    // API í‚¤ ë³µì‚¬
    function copyAPIKey() {
      const input = document.querySelector(".modal-input");
      if (!input.value) {
        alert("API Keyê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      navigator.clipboard.writeText(input.value)
        .then(() => alert("API Keyê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."))
        .catch(err => {
          console.error("ë³µì‚¬ ì‹¤íŒ¨:", err);
          alert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        });
    }

    // API í‚¤ ì¬ë°œê¸‰
    async function reissueAPIKey() {
      try {
        const response = await fetch('/reissue_api_key', {
          method: 'POST'
        });
        const result = await response.json();

        if (response.ok && result.api_key) {
          document.querySelector('.modal-input').value = result.api_key;
          document.querySelector('.expiration').innerText = result.api_expiration;
          alert('ìƒˆ API Keyê°€ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
          alert(result.message || 'API Key ì¬ë°œê¸‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('ì¬ë°œê¸‰ ìš”ì²­ ì‹¤íŒ¨:', err);
        alert('ì„œë²„ì™€ì˜ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
  </script>
</body>
</html>
